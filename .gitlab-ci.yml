default:
  image: registry.redhat.io/openshift4/ose-cli:latest

variables:
  # IMAGE_NAME should not have a tag at the end! That will be detemined based on branch
  IMAGE_NAME: quay-registry-quay-quay-enterprise.apps.hub.taco.moe/hello-world/hello-world

build-image:
  script:
    - |
      oc get buildconfig $CI_COMMIT_BRANCH &> /dev/null || cat << EOF
        apiVersion: build.openshift.io/v1
        kind: BuildConfig
        metadata:
          name: $CI_COMMIT_BRANCH
          namespace: gitlab-runner
        spec:
          failedBuildsHistoryLimit: 5
          output:
            pushSecret:
              name: push-secret # This needs to be created
            to:
              kind: DockerImage
              name: "${IMAGE_NAME}:${CI_COMMIT_BRANCH}"
          runPolicy: Serial
          source:
            git:
              ref: $CI_COMMIT_BRANCH
              uri: "${CI_PROJECT_URL}.git"
            type: Git
          strategy:
            sourceStrategy:
              from:
                kind: ImageStreamTag
                name: java:openjdk-17-ubi8
                namespace: openshift
            type: Source
          successfulBuildsHistoryLimit: 5
      EOF
    - oc start-build "$CI_COMMIT_BRANCH" --follow --wait
  only:
    - dev
    - test1
    - test2

build-release-image:
  script:
    - oc whoami
    - |
      oc new-build \
        "java~https://gitlab.taco.moe/hello-world/hello-world-spring-boot.git#$CI_COMMIT_SHORT_SHA" \
        --name "release-$CI_COMMIT_SHORT_SHA" \
        --push-secret push-secret \
        --to "quay-registry-quay-quay-enterprise.apps.hub.taco.moe/hello-world/hello-world:$CI_COMMIT_SHORT_SHA" \
        --to-docker \
        --follow \
        --wait
  only:
    - main
