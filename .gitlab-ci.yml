default:
  image: registry.redhat.io/openshift4/ose-cli:latest

variables:
  APP_NAME: hello-world
  # IMAGE_NAME should not have a tag at the end! That will be detemined based on branch
  IMAGE_NAME: quay-registry-quay-quay-enterprise.apps.hub.taco.moe/hello-world/hello-world

build-image:
  script:
    - |
      oc get buildconfig "${APP_NAME}-${CI_COMMIT_BRANCH}" &> /dev/null || oc create -f - << EOF
        apiVersion: build.openshift.io/v1
        kind: BuildConfig
        metadata:
          name: "${APP_NAME}-${CI_COMMIT_BRANCH}"
          namespace: gitlab-runner
        spec:
          failedBuildsHistoryLimit: 5
          output:
            pushSecret:
              name: push-secret # This needs to be created
            to:
              kind: DockerImage
              name: "${IMAGE_NAME}:${CI_COMMIT_BRANCH}"
          runPolicy: Serial
          source:
            git:
              ref: $CI_COMMIT_BRANCH
              uri: "${CI_PROJECT_URL}.git"
            type: Git
          strategy:
            sourceStrategy:
              from:
                kind: ImageStreamTag
                name: java:openjdk-17-ubi8
                namespace: openshift
            type: Source
          successfulBuildsHistoryLimit: 5
      EOF
    - oc start-build "${APP_NAME}-${CI_COMMIT_BRANCH}" --follow --wait
  only:
    - dev
    - test1
    - test2

build-release-image:
  script:
    - |
      oc get buildconfig "${APP_NAME}-${CI_COMMIT_SHORT_SHA}" &> /dev/null || oc create -f - << EOF
        apiVersion: build.openshift.io/v1
        kind: BuildConfig
        metadata:
          name: "${APP_NAME}-${CI_COMMIT_SHORT_SHA}"
          namespace: gitlab-runner
        spec:
          failedBuildsHistoryLimit: 5
          output:
            pushSecret:
              name: push-secret # This needs to be created
            to:
              kind: DockerImage
              name: "${IMAGE_NAME}:${CI_COMMIT_SHORT_SHA}"
          runPolicy: Serial
          source:
            git:
              ref: $CI_COMMIT_BRANCH
              uri: "${CI_PROJECT_URL}.git"
            type: Git
          strategy:
            sourceStrategy:
              from:
                kind: ImageStreamTag
                name: java:openjdk-17-ubi8
                namespace: openshift
            type: Source
          successfulBuildsHistoryLimit: 5
      EOF
    - oc start-build "${APP_NAME}-${CI_COMMIT_SHORT_SHA}" --follow --wait
  only:
    - main
